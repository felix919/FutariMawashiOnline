<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>サンプル</title>
    <script type="text/javascript" src="./Sortable-master/Sortable.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // ポケモンカードのmodel
        function PokemonCard(_no, _name, _url) {
            // デッキの何番目かを示す(0 ~ 59)
            this.no = _no
            // カード名
            this.name = _name
            // 画像URL
            this.url = _url
        }

        // ポケモンカードを60枚持つデッキ
        var deck = []

        $(function () {
            // ボタン押下時にデッキコードからデッキを作成する
            $('#getDeckCode').click(function () {
                $.get("https://www.pokemon-card.com/deck/deck.html?deckID=" + $('#deckCode').val(),
                    {},
                    function (response) {
                        // 改行ごとに配列に分ける
                        let lineArray = response.split(/\r\n|\r|\n/);
                        $.each(lineArray, function(index, line) {
                            // ポケモンをデッキに入れる
                            if (line.indexOf("deck_pke") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let pokemons = value.split("-")
                                // デッキにいれる
                                $.each(pokemons, function(index, pokemon) {
                                    let cardSplit = pokemon.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // グッズをデッキに入れる
                            if (line.indexOf("deck_gds") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let items = value.split("-")
                                // デッキにいれる
                                $.each(items, function(index, item) {
                                    let cardSplit = item.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // サポーターをデッキに入れる
                            if (line.indexOf("deck_sup") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let supporters = value.split("-")
                                // デッキにいれる
                                $.each(supporters, function(index, supporter) {
                                    let cardSplit = supporter.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // スタジアムをデッキに入れる
                            if (line.indexOf("deck_sta") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let stadiums = value.split("-")
                                // デッキにいれる
                                $.each(stadiums, function(index, stadium) {
                                    let cardSplit = stadium.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // エネルギーをデッキに入れる
                            if (line.indexOf("deck_ene") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let energies = value.split("-")
                                // デッキにいれる
                                $.each(energies, function(index, energy) {
                                    let cardSplit = energy.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // 画像URLを入れる
                            if (line.indexOf("searchItemCardPict") !== -1) {
                                let id = line.substring(27, 32)
                                $.each(deck, function (index, card) {
                                    if (card.name == id) {
                                        card.url = "https://www.pokemon-card.com" + line.split("'")[1]
                                    }
                                })
                            }

                        })

                        // デッキ内容を出力する
                        var output = ""
                        var imgList = document.getElementById("img")
                        $.each(deck, function(index, card) {
                            output += card.no + "番目, ID: " + card.name + ", 画像URL: " + card.url + "\n"
                            var img = document.createElement("li")
                            img.innerHTML = "<img src=" + card.url + " width=\"10%\" height=\"10%\">"
                            imgList.appendChild(img)
                        })
                        $("pre").text(output)

                        // 並べ替え可能なドラッグアンドドロップリストの作成
                        var imgList = document.getElementById("img")
                        var sortableImg = Sortable.create(imgList, {animation: 100})
                    }
                );
            });
        });
    </script>
</head>

<body>
    <h1> デッキ内容を表示 </h1>
    <label for="inputDeckCode">デッキコードを入力してください</label>
    <input type="text" id="deckCode">
    <input type="button" id="getDeckCode" value="デッキを登録">
    <pre>aaa</pre>
    <ul id="img">
    </ul>
</body>

</html>
