<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>サンプル</title>
    <script type="text/javascript" src="./Sortable-master/Sortable.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="./css/style.css">
    <script>
        // ポケモンカードのmodel
        function PokemonCard(_no, _name, _url) {
            // デッキの何番目かを示す(0 ~ 59)
            this.no = _no
            // カード名
            this.name = _name
            // 画像URL
            this.url = _url
        }

        // ポケモンカードを60枚持つデッキ
        var deck = []

        $(function () {
            // ボタン押下時にデッキコードからデッキを作成する
            $('#getDeckCode').click(function () {
                $.get("https://www.pokemon-card.com/deck/deck.html?deckID=" + $('#deckCode').val(),
                    {},
                    function (response) {
                        // デッキを作成する
                        deck.splice(0);
                        let lineArray = response.split(/\r\n|\r|\n/);
                        $.each(lineArray, function(index, line) {
                            // ポケモンをデッキに入れる
                            if (line.indexOf("deck_pke") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let pokemons = value.split("-")
                                // デッキにいれる
                                $.each(pokemons, function(index, pokemon) {
                                    let cardSplit = pokemon.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // グッズをデッキに入れる
                            if (line.indexOf("deck_gds") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let items = value.split("-")
                                // デッキにいれる
                                $.each(items, function(index, item) {
                                    let cardSplit = item.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // サポーターをデッキに入れる
                            if (line.indexOf("deck_sup") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let supporters = value.split("-")
                                // デッキにいれる
                                $.each(supporters, function(index, supporter) {
                                    let cardSplit = supporter.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // スタジアムをデッキに入れる
                            if (line.indexOf("deck_sta") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let stadiums = value.split("-")
                                // デッキにいれる
                                $.each(stadiums, function(index, stadium) {
                                    let cardSplit = stadium.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // エネルギーをデッキに入れる
                            if (line.indexOf("deck_ene") !== -1) {
                                // valueを抽出する
                                let value = $.trim(line).split(" ")[4].replace("value=", "").replace(/"/g, "")
                                // カードの種類ごとに分ける
                                let energies = value.split("-")
                                // デッキにいれる
                                $.each(energies, function(index, energy) {
                                    let cardSplit = energy.split("_")
                                    for (let i = 0; i < cardSplit[1]; i++) {
                                        deck.push(new PokemonCard(deck.length, cardSplit[0], ""))
                                    }
                                })
                            }

                            // 画像URLを入れる
                            if (line.indexOf("searchItemCardPict") !== -1) {
                                let id = line.substring(27, 32)
                                $.each(deck, function (index, card) {
                                    if (card.name == id) {
                                        card.url = "https://www.pokemon-card.com" + line.split("'")[1]
                                    }
                                })
                            }

                        })

                        // デッキ内容を出力する
                        var deckList = document.getElementById("deck")
                        shuffle(deck)
                        while(deckList.firstChild) {
                            deckList.removeChild(deckList.firstChild)
                        }
                        var handList = document.getElementById("hand")
                        while(handList.firstChild) {
                            handList.removeChild(handList.firstChild)
                        }

                        // 手札分デッキから引き、手札エリアに表示する
                        for (let i = 0; i < 7; i++) {
                            var liImg = document.createElement("li")
                            liImg.innerHTML = "<img src=" + deck.shift().url + " width=\"100%\" height=\"100%\">"
                            handList.appendChild(liImg)
                        }

                        // 残りの山札を表示する
                        $.each(deck, function(index, card) {
                            var img = document.createElement("li")
                            img.innerHTML = "<img src=" + card.url + " width=\"100%\" height=\"100%\">"
                            deckList.appendChild(img)
                        })

                        // 並べ替え可能なドラッグアンドドロップリストの作成 
                        var sortableDeckImg = Sortable.create(deckList, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var stadiumImg = document.getElementById("stadium")
                        var sortableStadiumImg = Sortable.create(stadiumImg, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var battleImg = document.getElementById("battle")
                        var sortableBattleImg = Sortable.create(battleImg, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var bench1Img = document.getElementById("bench1")
                        var sortableBench1Img = Sortable.create(bench1Img, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var bench2Img = document.getElementById("bench2")
                        var sortableBench1Img = Sortable.create(bench2Img, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var bench3Img = document.getElementById("bench3")
                        var sortableBench1Img = Sortable.create(bench3Img, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var bench4Img = document.getElementById("bench4")
                        var sortableBench4Img = Sortable.create(bench4Img, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var bench5Img = document.getElementById("bench5")
                        var sortableBench5Img = Sortable.create(bench5Img, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var sortableHandList = Sortable.create(handList, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var sideImg = document.getElementById("side")
                        var sortableSideImg = Sortable.create(sideImg, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var trashImg = document.getElementById("trash")
                        var sortableTrashImg = Sortable.create(trashImg, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                        var lostzoneImg = document.getElementById("lostzone")
                        var sortableLostzoneImg = Sortable.create(lostzoneImg, {
                            group: {
                                name: "card"
                            },
                            animation: 100
                        })
                    }
                );
            });

            // 1枚ドローする
            $('#draw').click(function () {
                var handList = document.getElementById("hand")
                var deckList = document.getElementById("deck")
                handList.appendChild(deckList.firstChild)
                deckList.removeChild(deckList.firstChild)
            });
        });

        //シャッフル関数
        function shuffle(array) {
        var m = array.length, t, i;
            while (m) {
                i = Math.floor(Math.random() * m--);
                t = array[m];
                array[m] = array[i];
                array[i] = t;
            }
        }
    </script>
</head>

<body>
    <h1> デッキ内容を表示 </h1>
    <label for="inputDeckCode">デッキコードを入力してください</label>
    <input type="text" id="deckCode" value="ngQNn9-G35BmJ-QLn96L">
    <input type="button" id="getDeckCode" value="デッキを登録">
    <ul id="deck" class="deckList">
    </ul>
    <div class="playArea">
        <div class="sideArea">
            <ul id="side" class="sideList">
            </ul>
        </div>
        <div class="battleArea">
            <ul id="stadium" class="stadiumList">
            </ul>
            <ul id="battle" class="battleList">
            </ul>
        </div>
        <div class="nullArea">
        </div>
        <div class="benchArea">
            <ul id="bench1" class="bench">
            </ul>
            <ul id="bench2" class="bench">
            </ul>
            <ul id="bench3" class="bench">
            </ul>
            <ul id="bench4" class="bench">
            </ul>
            <ul id="bench5" class="bench">
            </ul>
        </div>
    </div>
    <div class="handAndTrashAndLostzoneArea">
        <ul id="hand" class="handList">
        </ul>
        <div class="buttonArea">
            <button type="button" id="draw" class="handButton">1枚ドロー</button>
            <button type="button" id="topFive" class="handButton">上から5枚見る</button>
            <button type="button" id="checkDeck" class="handButton">山札を見る</button>
            <button type="button" id="marry" class="handButton">マリィ</button>
        </div>
        <ul id="trash" class="otherList">
        </ul>
        <ul id="lostzone" class="otherList">
        </ul>
    </div>
    
</body>

</html>
